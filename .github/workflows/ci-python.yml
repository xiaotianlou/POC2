name: ci-python

on:
  push:
    branches: main           # 任意分支 push 都跑，PR 分支也能自测

  pull_request:
    branches: main           # 任意目标分支的 PR 都跑
  workflow_dispatch: {}         # 手动触发（调试很方便）

permissions:
  contents: read

jobs:
  ruff:
    name: Ruff (lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install deps
        run: |
          set -eux
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install ruff
      - name: Run ruff
        run: ruff check . --output-format=github

  pylint:
    name: Pylint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install deps
        run: |
          set -eux
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pylint
      - name: Run pylint
        run: |
          set -e
          FILES="$(git ls-files '*.py' || true)"
          if [ -n "$FILES" ]; then
            echo "$FILES" | xargs -r pylint
          else
            echo "No Python files to lint. Skipping."
          fi

  pytest:
    name: PyTest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install deps
        run: |
          set -eux
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # 如需安装项目本体，取消下一行注释
          # pip install -e .
          pip install pytest pytest-cov
      - name: Run tests
        env:
          # 兼容 src 布局未安装的情况；已安装也不冲突
          PYTHONPATH: ${{ github.workspace }}/src:${{ github.workspace }}
        run: |
          if [ -d tests ]; then
            pytest -q --maxfail=1 --disable-warnings \
                   --cov=. --cov-report=term-missing
          else
            echo "No tests/ directory found. Skipping."
          fi
